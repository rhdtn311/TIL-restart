## 목차

1. [개요](https://www.google.com/search?q=%231-%EA%B0%9C%EC%9A%94)
2. [외부 연동 장애의 본질](https://www.google.com/search?q=%232-%EC%99%B8%EB%B6%80-%EC%97%B0%EB%8F%99-%EC%9E%A5%EC%95%A0%EC%9D%98-%EB%B3%B8%EC%A7%88)
3. [타임아웃 전략](https://www.google.com/search?q=%233-%ED%83%80%EC%9E%84%EC%95%84%EC%9B%83-%EC%A0%84%EB%9E%B5)
* [연결 타임아웃](https://www.google.com/search?q=%2331-%EC%97%B0%EA%B2%B0-%ED%83%80%EC%9E%84%EC%95%84%EC%9B%83-connect-timeout)
* [읽기 타임아웃](https://www.google.com/search?q=%2332-%EC%9D%BD%EA%B8%B0-%ED%83%80%EC%9E%84%EC%95%84%EC%9B%83-read-timeout)


4. [재시도 전략](https://www.google.com/search?q=%234-%EC%9E%AC%EC%8B%9C%EB%8F%84-%EC%A0%84%EB%9E%B5)
* [멱등성](https://www.google.com/search?q=%2341-%EB%A9%B1%EB%93%B1%EC%84%B1)
* [재시도 대상과 제외 대상](https://www.google.com/search?q=%2342-%EC%9E%AC%EC%8B%9C%EB%8F%84-%EB%8C%80%EC%83%81%EA%B3%BC-%EC%A0%9C%EC%99%B8-%EB%8C%80%EC%83%81)
* [백오프와 지터](https://www.google.com/search?q=%2343-%EB%B0%B1%EC%98%A4%ED%94%84%EC%99%80-%EC%A7%80%ED%84%B0)


5. [동시 요청 제한](https://www.google.com/search?q=%235-%EB%8F%99%EC%8B%9C-%EC%9A%94%EC%B2%AD-%EC%A0%9C%ED%95%9C)
* [세마포어](https://www.google.com/search?q=%2351-%EC%84%B8%EB%A7%88%ED%8F%AC%EC%96%B4)
* [벌크헤드](https://www.google.com/search?q=%2352-%EB%B2%8C%ED%81%AC%ED%97%A4%EB%93%9C)


6. [서킷 브레이커](https://www.google.com/search?q=%236-%EC%84%9C%ED%82%B7-%EB%B8%8C%EB%A0%88%EC%9D%B4%EC%BB%A4)
* [상태 모델](https://www.google.com/search?q=%2361-%EC%83%81%ED%83%9C-%EB%AA%A8%EB%8D%B8)
* [임계치 판단 기준](https://www.google.com/search?q=%2362-%EC%9E%84%EA%B3%84%EC%B9%98-%ED%8C%90%EB%8B%A8-%EA%B8%B0%EC%A4%80)
* [빠른 실패](https://www.google.com/search?q=%2363-%EB%B9%A0%EB%A5%B8-%EC%8B%A4%ED%8C%A8)


7. [외부 연동과 DB 연동 설계](https://www.google.com/search?q=%237-%EC%99%B8%EB%B6%80-%EC%97%B0%EB%8F%99%EA%B3%BC-db-%EC%97%B0%EB%8F%99-%EC%84%A4%EA%B3%84)
* [트랜잭션 분리](https://www.google.com/search?q=%2371-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EB%B6%84%EB%A6%AC)
* [데이터 일관성 문제](https://www.google.com/search?q=%2372-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%9D%BC%EA%B4%80%EC%84%B1-%EB%AC%B8%EC%A0%9C)
* [대표 장애 시나리오 분석](https://www.google.com/search?q=%2373-%EB%8C%80%ED%91%9C-%EC%9E%A5%EC%95%A0-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4-%EB%B6%84%EC%84%9D)


8. [실무 적용 사례](https://www.google.com/search?q=%238-%EC%8B%A4%EB%AC%B4-%EC%A0%81%EC%9A%A9-%EC%82%AC%EB%A1%80)
9. [마무리하며](https://www.google.com/search?q=%239-%EB%A7%88%EB%AC%B4%EB%A6%AC%ED%95%98%EB%A9%B0)

---

### 1. 개요

> 이 문서는 사용자의 초안을 바탕으로 Gemini가 체계적으로 구조화하고 내용을 다듬어 작성했다.

본 문서는 『주니어 백엔드 개발자가 반드시 알아야 할 실무 지식』 4장의 핵심 내용을 정리한 기술 문서다. 외부 시스템 연동 시 발생할 수 있는 장애를 **시스템 전체 장애로 확산시키지 않기 위한 방어적 설계 전략**을 다룬다.

---

### 2. 외부 연동 장애의 본질

외부 시스템은 언제든지 느려지거나 실패할 수 있다. 우리 서비스의 코드가 아무리 완벽해도, 외부 연동 지점에서의 설계가 부실하면 전체 서비스가 함께 무너질 위험이 있다.

핵심 문제는 다음 두 가지다.

* **전파:** 외부의 장애가 우리 시스템으로 전파되는 것
* **고갈:** 외부 지연으로 인해 우리 시스템의 자원(스레드, 커넥션 등)이 고갈되는 것

이 문서는 이러한 문제를 방지하기 위한 타임아웃, 재시도, 동시 요청 제한, 서킷 브레이커 등의 기법을 단계적으로 설명한다.

---

### 3. 타임아웃 전략

타임아웃은 외부 연동에서 가장 기본적이면서도 중요한 안전장치다. 무한정 응답을 기다리는 상황을 방지하여 자원을 보호한다.

#### 3.1 연결 타임아웃 (Connect Timeout)

연결 타임아웃은 외부 서버와 **물리적인 TCP 연결(3-way handshake)을 맺기까지 기다리는 최대 시간**이다.

* **적용 구간:** TCP 연결 수립 단계
* **주요 원인:** 상대 서버 다운, 잘못된 IP 주소, 방화벽 차단 등
* **권장 설정:** 1~5초 (연결은 빠르게 이루어져야 하므로 짧게 설정한다.)

#### 3.2 읽기 타임아웃 (Read Timeout)

읽기 타임아웃은 연결이 완료된 이후 **응답 데이터를 수신하기까지 기다리는 최대 시간**이다. 흔히 **소켓 타임아웃(Socket Timeout)**이라고도 한다.

* **적용 구간:** 데이터 수신 단계
* **주요 원인:** 외부 서버의 내부 처리 지연, DB 병목, 복잡한 비즈니스 로직 수행 등
* **권장 설정:** 5~30초 (비즈니스 로직에 따라 유동적으로 설정한다.)

---

### 4. 재시도 전략

재시도는 일시적인 네트워크 오류나 타임아웃 발생 시 성공률을 높이는 도구다. 그러나 잘못 사용하면 트래픽 폭주를 유발하여 장애를 확산시킬 수 있다.

#### 4.1 멱등성

재시도 전략 적용의 전제 조건은 **멱등성(Idempotency)** 보장 여부다.

* **멱등한 요청:** 여러 번 수행해도 결과가 같은 요청
* 예: 조회(GET), 상태 덮어쓰기(PUT)


* **멱등하지 않은 요청:** 수행 횟수만큼 결과가 변하는 요청
* 예: 주문 생성(POST), 결제 승인, 포인트 차감



> **주의:** 멱등하지 않은 요청에 재시도를 적용하려면, 반드시 고유 요청 ID를 기반으로 서버 측에서 중복 처리를 차단하는 설계가 선행되어야 한다.

#### 4.2 재시도 대상과 제외 대상

무조건적인 재시도는 지양해야 하며, 에러 종류에 따라 구분해야 한다.

* **재시도 대상:** 일시적 오류
* 타임아웃
* HTTP 502 (Bad Gateway), 503 (Service Unavailable), 504 (Gateway Timeout)


* **재시도 제외:** 클라이언트 오류 또는 영구적 오류
* HTTP 4xx (잘못된 요청, 권한 없음 등)



#### 4.3 백오프와 지터

동시다발적인 재시도로 인한 '재시도 폭풍(Retry Storm)'을 막기 위해 다음 기법을 사용한다.

* **지수 백오프(Exponential Backoff):** 재시도 간격을 점진적으로 늘리는 방식 (예: 1초 → 2초 → 4초)
* **지터(Jitter):** 재시도 간격에 무작위성(Randomness)을 추가하여 요청 시점을 분산시키는 방식

---

### 5. 동시 요청 제한

동시 요청 제한은 시스템이 감당할 수 있는 **최대 작업량을 명시적으로 제한**하여, 특정 외부 시스템의 장애가 전체 자원을 독점하는 것을 막는 전략이다.

#### 5.1 세마포어 (Semaphore)

* 허용 가능한 동시 호출 수(Permit)를 제한한다.
* 호출한 스레드에서 그대로 실행되므로 오버헤드가 적고 단순하다.

#### 5.2 벌크헤드 (Bulkhead)

* 선박의 격벽(Bulkhead)처럼 **특정 외부 연동을 위한 전용 자원(스레드 풀 등)을 분리**한다.
* A 시스템 연동에 장애가 발생해 스레드가 고갈되어도, B 시스템 연동이나 내부 로직에는 영향을 주지 않는다.
* Java의 Resilience4j 라이브러리에서 주로 사용되는 방식이다.

---

### 6. 서킷 브레이커

서킷 브레이커는 타임아웃, 재시도, 동시 요청 제한을 종합하여 관리하는 **최종 방어선**이다. 특정 서비스의 장애 감지 시 즉시 연결을 차단하여 불필요한 호출을 막고 시스템 복구를 돕는다.

#### 6.1 상태 모델

* **Closed (정상):** 모든 호출이 정상적으로 통과된다.
* **Open (차단):** 장애 임계치를 초과하여 호출을 즉시 차단하고 에러를 반환한다.
* **Half-Open (반개방):** 일정 시간이 지난 후, 일부 호출만 허용하여 시스템이 복구되었는지 확인한다. 성공 시 Closed, 실패 시 다시 Open으로 전환한다.

#### 6.2 임계치 판단 기준

서킷 브레이커는 슬라이딩 윈도우(Sliding Window) 알고리즘을 기반으로 실패율을 계산한다.

* **개수 기반:** 최근 N번의 호출 중 실패 비율
* **시간 기반:** 최근 T초 동안의 호출 중 실패 비율
* **최소 호출 횟수:** 표본이 너무 적을 때의 오판을 막기 위해 최소 호출 횟수 조건을 설정해야 한다.

#### 6.3 빠른 실패 (Fail Fast)

서킷이 Open 상태일 때는 외부 시스템에 요청을 보내지 않고 **즉시 실패** 처리한다. 이를 통해 클라이언트의 불필요한 대기 시간을 없애고, 스레드 자원을 보호하며, 캐시 데이터나 기본값(Fallback)을 빠르게 반환할 수 있다.

---

### 7. 외부 연동과 DB 연동 설계

외부 API 호출은 네트워크 통신이므로 불확실성이 크다. 따라서 **DB 트랜잭션과 철저히 분리**해야 한다.

#### 7.1 트랜잭션 분리

외부 API 호출을 DB 트랜잭션 내부(범위 안)에서 수행하는 것은 매우 위험하다. 외부 시스템의 응답이 지연되면, 그 시간만큼 DB 커넥션을 점유하게 되어 **DB 커넥션 풀 고갈(Connection Pool Exhaustion)**로 이어진다.

> **원칙:** 외부 호출은 반드시 트랜잭션 외부에서 수행하고, DB 작업만 트랜잭션으로 묶는다.

#### 7.2 데이터 일관성 문제

외부 시스템 연동은 DB처럼 `ROLLBACK`이 불가능하다. 따라서 데이터 불일치 상황에 대비한 전략이 필요하다.

* **취소 API (보상 트랜잭션):** 실패 시 이전에 성공한 요청을 취소하는 API를 호출한다.
* **성공 여부 확인 API:** 타임아웃 등으로 결과가 불확실할 때 상태를 조회한다.
* **데이터 보정(Reconciliation):** 주기적인 배치 작업을 통해 양측 시스템의 데이터 상태를 맞춘다.

#### 7.3 대표 장애 시나리오 분석

| 상황 | 문제점 | 해결 방안 |
| --- | --- | --- |
| **트랜잭션 내 외부 연동 실패** | 작업 실패 시 롤백 필요 | 트랜잭션 롤백으로 데이터 일관성 유지 |
| **읽기 타임아웃 발생** | 외부 시스템의 성공/실패 여부 불확실 | 성공 확인 API 조회, 취소 API 호출, 주기적 보정 |
| **외부 연동 성공 후 DB 실패** | 외부는 반영되었으나 내부는 롤백됨 | 보상 트랜잭션(취소 요청), 비동기 이벤트 처리 |
| **외부 지연으로 커넥션 고갈** | 전체 서비스 마비 위기 | 트랜잭션 범위 밖에서 외부 호출, 비동기 처리 |

---

### 8. 실무 적용 사례

> (추후 실무 적용 시 업데이트 예정)

---

### 9. 마무리하며

외부 시스템 연동의 핵심은 **"외부 시스템을 절대 신뢰하지 않고, 장애가 발생해도 내 시스템은 살아남도록 설계하는 것"**이다.

타임아웃을 통해 무한 대기를 막고, 재시도와 백오프로 일시적 오류를 극복하며, 서킷 브레이커와 격벽 패턴으로 장애 전파를 차단해야 한다. 마지막으로, 트랜잭션 분리를 통해 DB 자원을 보호하는 것이 안정적인 백엔드 시스템을 구축하는 지름길이다.
